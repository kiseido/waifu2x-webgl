<html>

<head>
    <style type="text/css">
    </style>
    <link href="css/main.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="js/common.js"></script>
    <script type="text/javascript" src="js/waifu2xgl.js"></script>
    <script type="text/javascript" src="js/main.js"></script>
    <script type="text/javascript">
        var canvas, image;
        function init(event) {
            if(document.readyState != 'complete') {
                return;
            }
            canvas = document.querySelector("#mycanvas");
            image = document.querySelector("#myimg");
        }
        function setStatus(msg) {
            let statusElem = document.querySelector("#status");
            statusElem.textContent = msg;
        }
        function stopOp(event) {
            const mycanvas = document.getElementById("mycanvas");
            if (mycanvas.dataset.opstatus)
                mycanvas.dataset.opstatus = 'stop';
        }
        function upscaleBegin(event) {
            event.preventDefault();

            let form = event.target;
            // const image = document.querySelector("#myimg");
            const option = "models/" + form['modeSelect'].selectedOptions[0].value;
            // const mycanvas = document.getElementById("mycanvas");

            // {WebGLRenderingContext}
            // const myctx = mycanvas.getContext('2d');
            scale(image, mycanvas, option);

        }
        function updateImage(event) {
            console.log("image", event);
            let fr = new FileReader();
            let imageInput = event.target;
            let file = imageInput.files[0];
            // let img = document.querySelector("#myimg");
            
            /** @param ProgressEvent **/
            fr.onload = function (event) {
                console.log(file, arguments);
                image.dataset.fileName = file.name;
                image.dataset.type = file.type;
                image.src = fr.result;
                setTimeout(function(){
                    copyImageToCanvas(image, canvas);
                });
            }

            fr.readAsDataURL(file);
        }
        document.onreadystatechange = init;
    </script>
</head>

<body>
    <section id="upscaler">
        <form onsubmit="upscaleBegin(event)">
            <span>Select your file:</span>
            <input required type="file" name="imageInput" accept="image/*" onchange="updateImage(event)">
            <span>Select your desired model:</span>
            <select name="modeSelect" required>
                <option hidden value="">Select a mode!</option>
                <option value="scale2.0x_model.json">Upscale 2x</option>
                <option value="noise1_model.json">Low Denoise & Upscale 2x</option>
                <option value="noise2_model.json">Medium Denoise & Upscale 2x</option>
                <option value="noise3_model.json">High Denoise & Upscale 2x</option>
            </select>
            <div>
                <span id="status">Waiting</span>
                <input type="submit" value="Run!">
                <input type="button" value="Stop" onclick="stopOp(event)">
            </div>

        </form>
        <div id="previewPane">
            <img id="myimg" style="display: none;">
            <canvas id="mycanvas"></canvas>
        </div>
    </section>
</body>

</html>